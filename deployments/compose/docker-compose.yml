
# docker-compose file for running a Penumbra node.
# Stores the node config in a docker "volume", which should be
# reset between networks: `docker volume rm compose_penumbra-pd-node0` or similar.
# See docs for details:  https://guide.penumbra.zone/node/pd/join-network.html
#
# N.B. the "latest" tag for Penumbra container images maps to the latest
# tagged release; use "main" tag for tracking the rolling preview networks.
services:

  # Initialize node config, via `pd network join`.
  pd-node0-init:
    image: ghcr.io/penumbra-zone/penumbra:local
    command: >-
      sh -c
      "
      pd --version &&
      if ! test -e /pd/network_data/node0/cometbft/config/config.toml ; then
        >&2 printf 'WARN: network config not found. Creating fresh local network.\n'
        # --allocation-address is mnemonic 'test test test test test test test test test test test junk' (commonly used in Ethereum)
        rm -rf /pd/network_data &&
        /bin/pd network --network-dir /pd/network_data generate --chain-id penumbra-local-devnet --preserve-chain-id --gas-price-simple 0 --unbonding-delay 302400 --epoch-duration 302400 --proposal-voting-blocks 50 --timeout-commit 500ms --allocation-address "penumbra1eu5pnv6qptp2p0aevfc0adjrpd24glz5shey7wvwlg5sp3ffca2zk32cemjd90ughdh7xqplrej9lqzc06337w2scxykjajd2nrtttvmqt6tssr6pmzp283hhte7y4jf6sn2wh"
      else
        >&2 echo 'Node config already found, using it'
      fi &&
      if test -d /pd/network_data/node0 ; then
        mkdir -p /pd/network_data/node0/cometbft/data &&
        chown 100 -R /pd/network_data/node0/cometbft &&
        chown 1000 -R /pd/network_data/node0/pd &&
        ls -l /pd/network_data/node0/ && exit 0
      else
        >&2 echo 'ERROR: network generation failed'
        exit 1
      fi
      "
    restart: on-failure
    volumes:
      - penumbra-pd-node0:/pd
    # run initcontainer as root so we can chown dirs for app containers.
    user: "0"

  # The Penumbra daemon
  pd-node0:
    image: ghcr.io/penumbra-zone/penumbra:local
    # consider verbose debugging logs:
    # environment:
    # RUST_LOG: h2=off,debug
    command: >-
      /bin/pd start --home /pd/network_data/node0/pd
      --grpc-bind 0.0.0.0:8080 --abci-bind 0.0.0.0:26658
      --cometbft-addr http://cometbft-node0:26657
    restart: on-failure
    volumes:
      - penumbra-pd-node0:/pd
    user: "${UID:-1000}"
    stop_signal: SIGKILL
    depends_on:
      - pd-node0-init
    ports:
      - "26658:26658"
      - "8080:8080"

  # The CometBFT node
  cometbft-node0:
    image: "docker.io/cometbft/cometbft:v0.37.15"
    ports:
      - "26656:26656"
      - "26657:26657"
    volumes:
      - penumbra-pd-node0:/cometbft
    user: "100"
    environment:
      CMTHOME: /cometbft/network_data/node0/cometbft
    command: start --proxy_app=tcp://pd-node0:26658
    depends_on:
      - pd-node0

volumes:
  penumbra-pd-node0: {}
